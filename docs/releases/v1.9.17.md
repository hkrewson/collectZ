# v1.9.17

## Version and date
- Version: `1.9.17`
- Date: `2026-02-23`

## Milestone target and status
- Target: 1.9.17 scope authority and membership enforcement
- Status: Completed

## Summary
Implemented server-authoritative scope resolution and cross-scope access rejection. Client-supplied scope hints are now non-authoritative by default and only accepted for explicitly allowed roles.

## What changed
### Backend
- Added scope access middleware:
  - `/backend/middleware/scopeAccess.js`
  - blocks unauthorized scope hints with `403`
  - validates scoped library existence and space/library consistency
  - enforces membership checks for non-admin scoped access
  - logs denied attempts as `scope.access.denied`
- Updated scope resolution utilities:
  - `/backend/db/scopeContext.js`
  - scope now resolves from server-side user context (`activeSpaceId`/`activeLibraryId`) or middleware-populated context
  - request headers/query/body are treated as hints, not trusted context
- Applied scope middleware to scoped routers:
  - `/backend/routes/media.js`
  - `/backend/routes/admin.js`
- Updated session lookup/auth user context:
  - `/backend/services/sessions.js` now returns `users.active_space_id` and `users.active_library_id`
  - `/backend/middleware/auth.js` attaches `activeSpaceId` and `activeLibraryId` to `req.user`

### Database
- Added migration `v15`:
  - `users.active_space_id`
  - `users.active_library_id`
  - `library_memberships` table with indexes
- Updated `/init.sql` parity for the same schema objects.

### CI
- Updated critical schema checks in `/.github/workflows/docker-publish.yml` to verify:
  - `users.active_space_id`
  - `users.active_library_id`
  - `library_memberships.library_id`

### Frontend
- No direct UI changes in this milestone.

## Breaking changes
- Requests that include unauthorized scope hints now return `403` (`Scope access denied`).

## New/changed environment variables
- No new environment variables.

## Migration notes and data-impact notes
- Migration `v15` is additive and non-destructive.
- Existing behavior remains unchanged when no explicit scoped context is configured.

## Deployment and verification steps
1. Rebuild and restart:
   - `docker compose --env-file .env up -d --build`
2. Confirm health version is `1.9.17`.
3. Confirm migration `v15` exists in `schema_migrations`.
4. Confirm non-admin request with `x-space-id` or `x-library-id` receives `403`.
5. Confirm `scope.access.denied` entry appears in Activity log for blocked attempts.

## Rollback guidance
- Roll back to prior image tag if needed.
- Restore DB backup if schema rollback is required.

## UI/API test checklist
- [ ] Standard media browsing/editing still works for non-admin users without scope headers.
- [ ] Non-admin scoped hint attempt is rejected with `403`.
- [ ] Admin scoped hint requests continue to function.
- [ ] Activity log records denied cross-scope attempts.

## Known issues and follow-up roadmap items
- Active scope selection UI and explicit membership management UI are not included in this milestone.
- Additional scope-management UX is planned in later milestones ahead of 2.0 multi-space rollout.
