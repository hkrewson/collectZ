# v1.9.16

## Version and date
- Version: `1.9.16`
- Date: `2026-02-23`

## Milestone target and status
- Target: 1.9.16 credential recovery and password reset workflow
- Status: Completed

## Summary
Completed credential-recovery hardening by requiring current password for self-service password changes, adding admin-issued one-time reset URLs, and introducing reset-token invalidation plus break-glass recovery docs.

## What changed
### Backend
- Added `password_reset_tokens` data model usage in auth/admin routes.
- Added `POST /api/auth/password-reset/consume` one-time reset endpoint.
- Enforced current-password verification for self-service password change in `PATCH /api/auth/profile`.
- Added session revocation helper and now revoke other sessions after password changes/resets.
- Added admin endpoint to generate reset links: `POST /api/admin/users/:id/password-reset`.
- Added admin endpoint to invalidate active reset links: `POST /api/admin/users/:id/password-reset/invalidate`.
- Expanded audit events for reset and password-change failure/success paths.

### Frontend
- Added reset-password route support (`/reset-password`) to auth screen.
- Added reset form flow (token + email + new password) in auth UI.
- Updated profile screen to require `Current Password` when changing password.
- Added member drawer controls to generate and invalidate password reset links.

### Database
- Added migration `v14` for `password_reset_tokens` table and indexes.
- Updated `init.sql` parity with `password_reset_tokens` table/indexes.

### Docs/Ops
- Updated configuration docs with password reset behavior and break-glass CLI recovery commands.
- Updated Portainer doc to remove legacy seeded-admin guidance.
- Updated CI migration verification to include `password_reset_tokens.token_hash`.

## Breaking changes
- Password change via profile now requires `current_password` when `password` is supplied.

## New/changed environment variables
- No new required environment variables for this milestone.

## Migration notes and data-impact notes
- Migration `v14` creates `password_reset_tokens` and supporting indexes.
- No destructive schema changes to existing user/media tables.
- Existing users/sessions remain valid until password change/reset events revoke prior sessions.

## Deployment and verification steps
1. Rebuild and restart stack:
   - `docker compose --env-file .env up -d --build`
2. Confirm backend health reports `1.9.16`.
3. Confirm migration `v14` applied:
   - `SELECT version, description FROM schema_migrations ORDER BY version DESC LIMIT 3;`
4. Admin -> Members -> Member Details:
   - Generate reset link, copy link, confirm audit event exists.
   - Invalidate active links, confirm audit event exists.
5. Open reset URL and set new password:
   - Confirm login succeeds with new password.
   - Confirm old sessions are invalidated.
6. Profile -> change password:
   - Missing/incorrect current password is rejected.
   - Correct current password succeeds.

## Rollback guidance
- Roll back to prior image tag if needed.
- If rollback includes schema rollback requirements, restore DB backup taken before applying migration `v14`.

## UI/API test checklist
- [ ] Admin can generate reset link for a member.
- [ ] Admin can invalidate active reset links.
- [ ] Reset link works once and then cannot be reused.
- [ ] Profile password change requires current password.
- [ ] Incorrect current password returns clear error.
- [ ] Successful password change keeps current session and revokes other sessions.
- [ ] Activity log includes reset create/consume/failure/invalidation events.

## Known issues and follow-up roadmap items
- Email delivery for reset links (SMTP dispatch) remains in a future milestone; current flow is copy-link delivery.
- Additional reset abuse protections (rate limiting/challenge policies) remain future hardening items.
